services:
  mongo:
    image: mongo:6.0
    restart: unless-stopped
    ports:
      - "27017:27017"
    volumes:
      - ./mongo-data:/data/db
    networks:
      - backend

  makoto-club-api:
    env_file:
      - ./env/shared.env
      - ${ENVIRONMENT_FILE:-./env/local.env}
    environment:
      # 同一ネットワーク上の ingress サービス名を使う
      MESSENGER_GATEWAY_URL: http://messenger-ingress:8080
      MESSENGER_GATEWAY_DESTINATION: discord-incoming
      # Mongo接続を明示的に渡す（env_file が効かないケースの保険）
      MONGO_URI: ${MONGO_URI:-mongodb://mongo:27017/makoto-club}
      MONGO_DB: ${MONGO_DB:-makoto-club}
      SURVEY_COLLECTION: ${SURVEY_COLLECTION:-surveys}
    ports:
      - "8080:8080"
    depends_on:
      - mongo

networks:
  backend:
    external: true
    name: infra-backend-network
